<!doctype html>
<html>
<head>
<title>A Magic clone</title>
<meta charset=utf-8>
<script src="lib/socket.io-1.3.5.js"></script>
<script src="lib/jquery-1.11.3.js"></script>
<script src="lib/underscore-1.8.3.js"></script>
<script src="lib/backbone-1.2.0.js"></script>
<script src="lib/hogan-3.0.1.js"></script>
<script src="lib/foundation.min.js"></script>
<script src="models/card.js"></script>
<script src="models/hand.js"></script>
<script src="models/warriors.js"></script>
<script src="views/turn.js"></script>
<script src="views/mana.js"></script>
<script src="views/card.js"></script>
<script src="views/hand.js"></script>
<script src="views/player.js"></script>
<script src="views/own_ground.js"></script>
<script src="views/opponent_ground.js"></script>
<link rel="stylesheet" href="css/foundation.css" />
<link rel="stylesheet" href="css/normalize.css" />
<link rel="stylesheet" href="css/style.css" />

<script>
var socket = io('http://127.0.0.1:3000'),
    battlefield = {},
    hands = {},

    ownId = null,
    opponentId = null,
    inTurn = false,
    manaView = null,
    attacker = null,
    defender = null,


    // Unintialized Views
    ownHand = null,
    ownGround = null,
    ownPlayer = null,
    opponentHand = null,
    opponentGround = null,
    opponentPlayer = null;

socket.on('joined', function (data) {
  console.log('Your ID:', data);
  ownId = data.player.id;
  hands[ownId] = new Hand();
  battlefield[ownId] = new Warriors();

  $('#battlefield').html('');
  $('#battlefield').prepend('<div class="' + ownId + '"><ul class="ground"></ul></div>');

  ownHand = new HandView({collection: hands[ownId], el:'#you > .util > ul', opponent: false});
  ownGround = new OwnGround({collection: battlefield[ownId], el: '#battlefield .' + ownId + ' .ground'});
  ownPlayer = new PlayerView({opponent: false, el: '#you .util .player'});
  ownPlayer.setHealth(data.player.health);
});

socket.on('rejected', function (data) {
  console.log('Rejected:', data);
});

socket.on('ready', function (data) {
});

socket.on('opponents', function (data) {
  console.log('Opponents:', data);
  opponentId = data[0].player.id;
  hands[opponentId] = new Hand();
  battlefield[opponentId] = new Warriors();

  $('#battlefield').prepend('<div class="' + opponentId + '"><ul class="ground"></ul></div>');

  opponentHand = new HandView({collection: hands[opponentId], el:'#opponent > .util > ul', opponent: true});
  opponentGround = new OpponentGround({collection: battlefield[opponentId], el: '#battlefield .' + opponentId + ' .ground'});
  opponentPlayer = new PlayerView({opponent: true, el: '#opponent .util .player'});
  opponentPlayer.setHealth(data[0].player.health);
});

socket.on('hands', function (data) {
  Object.keys(data).forEach(function(key) {
    if (key === 'you') {
      data['you']['hand'].forEach(function(d) {
        var card = new Card(d);
        hands[ownId].add(card);
      });
    } else {
      for (var i=0; i < data[key]['count']; i++) {
        var card = new Card({});
        card.set({'playerId': opponentId});
        hands[opponentId].add(card);
      }
    }
  });
  console.log('Hands:', data);
});

socket.on('turn', function (data) {
  inTurn = true;
  attacker = null;
  defender = null;
  battlefield[ownId].prepareTurn();
  battlefield[opponentId].prepareTurn();
  turnView.onTurn();
  manaView.setMana(data.mana, 0, true);
  console.log('Your turn. Current mana:', data.mana, data.card);
  if (data.card) {
    hands[ownId].add(new Card(data.card));
  } else {
    $('#you > .util > .deck').css('background-color', '#fff');
  }
  alert('Your turn!');
});

socket.on('wait', function (data) {
  inTurn = false;
  attacker = null;
  defender = null;
  battlefield[ownId].prepareTurn();
  battlefield[opponentId].prepareTurn();
  turnView.enemyTurn();
  console.log('You have to wait your turn. Current mana:', data.mana);
  if (data.card_for) {
    var card = new Card({});
    card.set({'playerId': data.card_for});
    hands[data.card_for].add(card);
  } else {
    $('#opponent > .util > .deck').css('background-color', '#fff');
  }
});

socket.on('unsick', function (data) {
  console.log('Card', data.card.id, 'from player', data.player.id, 'is ready to be used');
  battlefield[data.player.id].get(data.card.id).setSick(false);
});

socket.on('drawed-card', function (data) {
  console.log('Player', data.player, 'drawed card', String(data.card.id) + '. ' + String(data.mana - data.usedMana), 'mana remaining');
  var card = hands[data.player.id].get(data.card.id);
  hands[data.player.id].remove(card);
  if ((data.player.id === opponentId) && (card === undefined)) {
    opponentHand.removeUnknownCard(opponentId);
  }
  card = new Card(data.card);
  battlefield[data.player.id].add(card);

  if (data.player.id === ownId) {
    manaView.setMana(data.mana, data.usedMana, true);
  } else {
    manaView.setMana(data.mana, data.usedMana, false);
  }
});

socket.on('battle', function (data) {
  console.log('battledata', data);
  if (data.attacker.health <= 0) {
    ownGround.removeCard(data.attacker.card, data.attacker.player);
  } else {
    var card = battlefield[data.attacker.player.id].get(data.attacker.card.id);
    card.setHealth(data.attacker.health);
    card.setAttacker(false);
    card.setUsed(true);
  }

  if (data.defender.health <= 0) {
    opponentGround.removeCard(data.defender.card, data.defender.player);
  } else {
    var card = battlefield[data.defender.player.id].get(data.defender.card.id);
    card.setHealth(data.defender.health);
    card.setDefender(false);
  }

  if (data.player) {
    console.log('Player', data.player.id, 'has been hit with extra damage of', data.player.damageReceived);
    if (data.player.id === ownId) {
      ownPlayer.setHealth(data.player.health);
    } else {
      opponentPlayer.setHealth(data.player.health);
    }
  }
});

socket.on('direct-damage', function (data) {
  console.log('direct-damage', data);
  if (data.attacker.health <= 0) {
    ownGround.removeCard(data.attacker.card, data.attacker.player);
  } else {
    var card = battlefield[data.attacker.player.id].get(data.attacker.card.id);
    card.setHealth(data.attacker.health);
    card.setAttacker(false);
    card.setUsed(true);
  }
  if (data.player.id === ownId) {
    ownPlayer.setHealth(data.player.health);
    ownPlayer.setDefender(false);
  } else {
    opponentPlayer.setHealth(data.player.health);
    opponentPlayer.setDefender(false);
  }
});

socket.on('leader-defeated', function (data) {
  showMessage('Leader defeated', 'Leader', data, 'have been defeated');
});

socket.on('win', function (data) {
  showMessage('Victory', 'You have won');
});

socket.on('lose', function (data) {
  showMessage('Defeat', 'You have lost');
});

// Errors
socket.on('no-mana', function (data) {
  console.log('You don\'t have enough mana to play that card');
  showMessage('No mana', "You don't have enough mana to play that card");
});

socket.on('no-turn', function (data) {
  console.log('It is not your turn. You can not do anything');
});

socket.on('no-player', function (data) {
  console.log('That player does not exist');
});

socket.on('card-not-found', function (data) {
  console.log('That card is not yours');
  showMessage('Card not found', "That card does not exist here");
});

socket.on('card-sick', function (data) {
  console.log('You can not play that card because it is sick');
});

socket.on('card-used', function (data) {
  console.log('That card was already used');
});

socket.on('invalid-op', function (data) {
  console.log('Invalid operation. You can not do that');
});

function showMessage(title, message) {
  $("#modal-title").html(title);
  $("#modal-description").html(message);
  $('#modal-message').foundation('reveal', 'open');
}

$(document).ready(function() {
  turnView = new TurnView({el: '#end-turn'})
  manaView = new ManaView();
});

</script>

</head>

<body>
  <div id="application">
    <div id="opponent" class="row">
      <div class="util small-2 columns">
        <div class="deck"></div>
        <div class="controls bottom">
          <span id="enemy-turn" class="round alert label">Enemy turn</span>
        </div>
      </div>
      <div class="util small-8 columns">
        <ul class="hand"></ul>
      </div>
      <div class="util small-2 columns">
        <div class="mana-meter">
          <span name="10"></span>
          <span name="9"></span>
          <span name="8"></span>
          <span name="7"></span>
          <span name="6"></span>
          <span name="5"></span>
          <span name="4"></span>
          <span name="3"></span>
          <span name="2"></span>
          <span name="1"></span>
          <label>0/0</label>
        </div>
        <div class="player">
          <img src="images/unknown.png" />
          <label class="health">0</label>
        </div>
      </div>
    </div>

    <div id="battlefield"></div>

    <div id="you" class="row">
      <div class="util small-2 columns">
        <div class="mana-meter">
          <span name="10"></span>
          <span name="9"></span>
          <span name="8"></span>
          <span name="7"></span>
          <span name="6"></span>
          <span name="5"></span>
          <span name="4"></span>
          <span name="3"></span>
          <span name="2"></span>
          <span name="1"></span>
          <label>0/0</label>
        </div>
        <div class="player">
          <img src="images/unknown.png" />
          <label class="health">0</label>
        </div>
      </div>
      <div class="util small-8 columns">
        <ul class="hand"></ul>
      </div>
      <div class="util small-2 columns">
        <div class="controls top">
          <button id="action-turn" class="button round alert">Attack</button>
          <button id="end-turn" class="button round success">End turn</button>
        </div>
        <div class="deck"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-message" class="reveal-modal tiny" data-reveal aria-labelledby="modal-title" aria-hidden="true" role="dialog">
    <h2 id="modal-title"></h2>
    <p id="modal-description"></p>
    <a class="close-reveal-modal" aria-label="Close">&#215;</a>
  </div>
</body>

</html>
