<!doctype html>
<html>
<head>
<title>A Magic clone</title>
<meta charset=utf-8>
<script src="lib/socket.io-1.3.5.js"></script>
<script src="lib/jquery-1.11.3.js"></script>
<script src="lib/underscore-1.8.3.js"></script>
<script src="lib/backbone-1.2.0.js"></script>
<script src="lib/hogan-3.0.1.js"></script>
<script src="models/card.js"></script>
<script src="models/hand.js"></script>
<script src="views/turn.js"></script>
<script src="views/mana.js"></script>
<link rel="stylesheet" href="css/foundation.css" />
<link rel="stylesheet" href="css/normalize.css" />
<link rel="stylesheet" href="css/style.css" />

<script>
var socket = io('http://127.0.0.1:3000'),
    battlefield = {},
    hands = {},

    ownId = null,
    opponentId = null,
    inTurn = false,
    battlefieldView = null,
    manaView = null;

    // Unintialized Views
    ownHand = null,
    opponentHand = null,

socket.on('joined', function (data) {
  console.log('Your ID:', data);
  ownId = data;
  hands[ownId] = new Hand();
  ownHand = new HandView({collection: hands[ownId], el:'#you > .util > ul', opponent: false});
  battlefieldView.clear();
  battlefieldView.addPlayer(data);
});

socket.on('rejected', function (data) {
  console.log('Rejected:', data);
});

socket.on('ready', function (data) {
});

socket.on('opponents', function (data) {
  console.log('Opponents:', data);
  opponentId = data[0];
  hands[opponentId] = new Hand();
  opponentHand = new HandView({collection: hands[opponentId], el:'#opponent > .util > ul', opponent: true});
  battlefieldView.addPlayer(opponentId);
});

socket.on('hands', function (data) {
  Object.keys(data).forEach(function(key) {
    if (key === 'you') {
      data['you']['hand'].forEach(function(d) {
        var card = new Card(d);
        hands[ownId].add(card);
      });
    } else {
      for (var i=0; i < data[key]['count']; i++) {
        var card = new Card({});
        hands[opponentId].add(card);
      }
    }
  });
  console.log('Hands:', data);
});

socket.on('turn', function (data) {
  inTurn = true;
  alert('Your turn!');
  console.log('Your turn. Current mana:', data);
  turnView.onTurn();
  manaView.setMana(data, 0, true);
});

socket.on('wait', function (data) {
  console.log('You have to wait your turn. Current mana:', data);
  inTurn = false;
  turnView.enemyTurn();
});

socket.on('unsick', function (data) {
  console.log('Card', data.card.id, 'from player', data.player.id, 'is ready to be used');
  battlefieldView.unsickCard(data);
});

socket.on('drawed-card', function (data) {
  console.log('Player', data.player, 'drawed card', String(data.card.id) + '. ' + String(data.mana - data.usedMana), 'mana remaining');
  var card = ownHand.get(data.card.id);
  ownHand.remove(card);
  battlefieldView.addCard(data);
  if (data.player.id === ownId) {
    manaView.setMana(data.mana, data.usedMana, true);
  } else {
    manaView.setMana(data.mana, data.usedMana, false);
  }
});

socket.on('battle', function (data) {
  //console.log('Battle between card', data.attacker.card.id, 'from player', data.attacker.player.id, 'and card', data.defender.card.id, 'from player', data.defender.player.id);
  var attackerStats = ['damage dealt:', data.attacker.damageDealt, 'damage received:', data.attacker.damageReceived].join('');
  var defenderStats = ['damage dealt:', data.defender.damageDealt, 'damage received:', data.defender.damageReceived].join('');
  console.log('Battle');
  console.log('  Attacker: card', data.attacker.card.id, 'from player', data.attacker.player.id, attackerStats);
  console.log('  Defender: card', data.defender.card.id, 'from player', data.defender.player.id, defenderStats);
});

socket.on('direct-damage', function (data) {
  console.log([data.attacker.damageDealt, 'pt(s) of damage dealt to', data.player.id].join(' '));
});

socket.on('leader-defeated', function (data) {
  console.log('Leader', data, 'have been defeated');
});

socket.on('win', function (data) {
  console.log('You have won');
});

socket.on('lose', function (data) {
  console.log('You have been defeated');
});

// Errors
socket.on('no-mana', function (data) {
  console.log('You don\'t have enough mana to play that card');
});

socket.on('no-turn', function (data) {
  console.log('It is not your turn. You can not do anything');
});

socket.on('no-player', function (data) {
  console.log('That player does not exist');
});

socket.on('card-not-found', function (data) {
  console.log('That card is not yours');
});

socket.on('card-sick', function (data) {
  console.log('You can not play that card because it is sick');
});

socket.on('card-used', function (data) {
  console.log('That card was already used');
});

socket.on('invalid-op', function (data) {
  console.log('Invalid operation. You can not do that');
});

// Views

var CardView = Backbone.View.extend({
  tagName: 'li',
  className: 'card',
  attributes: {
    draggable: true,
  },
  events: {
    'click': 'draw',
    'dragstart': 'dragStart',
    'dragend': 'dragEnd'
  },
  initialize: function(options) {
    this.reversed = options.reversed;
  },
  render: function() {
    var html = null;
    if (this.reversed) {
      html = '';
    } else {
      this.$el.attr('data-drawed', this.model.get('drawed'));
      this.$el.attr('data-sick', this.model.get('sick'));
      this.$el.attr('data-card-id', this.model.get('id'));
      this.$el.attr('id', ownId + "-" + this.model.get('id'));

      html = '<div class="mana">' + this.model.get('mana') + '</div>' +
        '<div class="name">' + this.model.get('name') + '</div>' +
        '<div class="stats">' +  this.model.get('attack') + '/' + this.model.get('health') + '</div>';
    }
    this.$el.html(html);
    return this;
  },
  draw: function() {
    if (this.reversed) return;
    if (this.drawed) return;
    if (!inTurn) return;

    socket.emit('draw', this.model.get('id'));
  },
  dragStart: function(e) {
    var event = e.originalEvent;
    var data = {
      'id': this.model.get('id'),
      'drawed': this.model.get('drawed'),
      'sick': this.model.get('sick')
    };
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData("text/plain", JSON.stringify(data));
  },
  dragEnd: function(e) {
  }
});

var HandView = Backbone.View.extend({
  initialize: function(options) {
    this.opponent = options.opponent,
    this.collection.on('add', this.addCard, this);
    this.collection.on('remove', this.removeCard, this);
  },
  addCard: function(card) {
    var cardView = null;
    if (this.opponent) {
      cardView = new CardView({model: card, reversed: true});
    } else {
      cardView = new CardView({model: card, reversed: false});
    }
    this.$el.append(cardView.render().el);
  },
  removeCard: function(card) {
    $('#' + ownId + '-' + card.id).remove();
  },
  render: function() {
    this.collection.forEach(this.addCard, this);
    return this;
  }
});

var BattlefieldView = Backbone.View.extend({
  clear: function() {
    $('#battlefield').html('');
  },
  addPlayer: function(playerId) {
    $('#battlefield').prepend('<div class="' + playerId + '"><ul class="ground"></ul></div>');
    if (playerId === ownId) {
      var ground = $('#battlefield .' + playerId + ' .ground');
      ground.on('dragenter', this.dragEnter);
      ground.on('dragover', this.dragOver);
      ground.on('dragleave', this.dragLeave);
      ground.on('drop', this.dropCard);
    }
  },
  addCard: function(data) {
    var card = new Card(data.card);
    var cardView = new CardView({model: card, reversed: false})
    $('#battlefield .' + data.player.id + ' .ground').append(cardView.render().el);
  },
  unsickCard: function(data) {
    $('#' + data.player.id + '-' + data.card.id).removeClass('sick');
  },
  dropCard: function(e) {
    var event = e.originalEvent;
    var data = JSON.parse(event.dataTransfer.getData("text/plain"));
    e.target.style.border = "none";
    if (!data.drawed) {
      var cardId = data.id;
      e.preventDefault();
      socket.emit('draw', cardId);
      return false;
    }
  },
  dragEnter: function(e) {
    var event = e.originalEvent;
    var data = JSON.parse(event.dataTransfer.getData("text/plain"));
    if (!data.drawed) {
      e.target.style.border = "1px dashed #000";
      e.preventDefault();
      return false;
    }
  },
  dragOver: function(e) {
    //e.preventDefault();
    //return false;
  },
  dragLeave: function(e) {
    e.target.style.border = "none";
    e.preventDefault();
    return false;
  }
});

var ControlledGroundView = Backbone.View.extend({
  addCard: function(data) {
    var card = new Card(data.card);
    var cardView = new CardView({model: card, reversed: false})
    $('#battlefield .' + data.player.id + ' .ground').append(cardView.render().el);
  },
  unsickCard: function(data) {
    $('#' + data.player.id + '-' + data.card.id).removeClass('sick');
  },
  dropCard: function(e) {
    var event = e.originalEvent;
    var data = JSON.parse(event.dataTransfer.getData("text/plain"));
    e.target.style.border = "none";
    if (!data.drawed) {
      var cardId = data.id;
      e.preventDefault();
      socket.emit('draw', cardId);
      return false;
    }
  },
  dragEnter: function(e) {
    var event = e.originalEvent;
    var data = JSON.parse(event.dataTransfer.getData("text/plain"));
    if (!data.drawed) {
      e.target.style.border = "1px dashed #000";
      e.preventDefault();
      return false;
    }
  },
  dragOver: function(e) {
    //e.preventDefault();
    //return false;
  },
  dragLeave: function(e) {
    e.target.style.border = "none";
    e.preventDefault();
    return false;
  }

});

$(document).ready(function() {
  battlefieldView = new BattlefieldView();
  turnView = new TurnView({el: '#end-turn'})
  manaView = new ManaView();
});

</script>

</head>

<body>
  <div id="application">
    <div id="opponent" class="row">
      <div class="util small-2 columns">
        <div class="deck"></div>
        <div class="controls bottom">
          <span id="enemy-turn" class="round alert label">Enemy turn</span>
        </div>
      </div>
      <div class="util small-8 columns">
        <ul class="hand"></ul>
      </div>
      <div class="util small-2 columns">
        <div class="mana">
          <label>1/1</label>
          <span name="1"></span>
          <span name="2"></span>
          <span name="3"></span>
          <span name="4"></span>
          <span name="5"></span>
          <span name="6"></span>
          <span name="7"></span>
          <span name="8"></span>
          <span name="9"></span>
          <span name="10"></span>
        </div>
      </div>
    </div>

    <div id="battlefield"></div>

    <div id="you" class="row">
      <div class="util small-2 columns">
        <div class="mana">
          <span name="10"></span>
          <span name="9"></span>
          <span name="8"></span>
          <span name="7"></span>
          <span name="6"></span>
          <span name="5"></span>
          <span name="4"></span>
          <span name="3"></span>
          <span name="2"></span>
          <span name="1"></span>
          <label></label>
        </div>
      </div>
      <div class="util small-8 columns">
        <ul class="hand"></ul>
      </div>
      <div class="util small-2 columns">
        <div class="controls top">
          <button id="end-turn" class="button round success">End turn</button>
        </div>
        <div class="deck"></div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>
